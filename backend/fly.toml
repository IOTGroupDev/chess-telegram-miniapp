# =====================================
# Fly.io Configuration - FREE TIER
# Chess Telegram Mini App Backend
# =====================================

app = "chess-backend"
primary_region = "fra"  # Frankfurt (closest to Europe/Russia)

# Kill other apps when deploying (free tier only allows 1 app)
kill_signal = "SIGINT"
kill_timeout = 5

# ===================================
# Build Configuration
# ===================================
[build]
  dockerfile = "Dockerfile"

# ===================================
# Environment Variables
# ===================================
[env]
  NODE_ENV = "production"
  PORT = "3000"
  STOCKFISH_PATH = "/usr/games/stockfish"
  STOCKFISH_THREADS = "1"  # Free tier has limited CPU
  STOCKFISH_HASH_SIZE = "128"  # Limited RAM

# ===================================
# HTTP Service
# ===================================
[http_service]
  internal_port = 3000
  force_https = true
  auto_stop_machines = true   # Sleep when no traffic (save resources)
  auto_start_machines = true  # Wake up on request
  min_machines_running = 0    # Can go to 0 machines

  # Timeouts
  [[http_service.checks]]
    interval = "30s"
    timeout = "5s"
    grace_period = "10s"
    method = "GET"
    path = "/health"

# ===================================
# Scaling & Concurrency
# ===================================
[services.concurrency]
  type = "requests"
  hard_limit = 250
  soft_limit = 200

# Free tier: Up to 3 shared-cpu-1x machines
[[services.machines]]
  cpu_kind = "shared"
  cpus = 1
  memory_mb = 256

# ===================================
# Metrics (optional)
# ===================================
[metrics]
  port = 9091
  path = "/metrics"

# ===================================
# Restart Policy
# ===================================
[restart]
  policy = "on-failure"
  max_retries = 3

# ===================================
# Deploy Configuration
# ===================================
[deploy]
  strategy = "rolling"

# ===================================
# Usage Notes:
# ===================================
#
# Deploy:
#   fly deploy
#
# Set secrets:
#   fly secrets set SUPABASE_URL=https://...
#   fly secrets set SUPABASE_SERVICE_KEY=...
#   fly secrets set REDIS_URL=redis://...
#   fly secrets set DEEPSEEK_API_KEY=...
#
# Scale (if needed):
#   fly scale count 2  # 2 machines (still free)
#   fly scale memory 512  # More RAM (may cost)
#
# Logs:
#   fly logs
#
# SSH:
#   fly ssh console
#
# ===================================
