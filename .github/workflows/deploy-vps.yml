name: Deploy to VPS

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # ÐŸÐ¾Ð·Ð²Ð¾Ð»ÑÐµÑ‚ Ð·Ð°Ð¿ÑƒÑÐºÐ°Ñ‚ÑŒ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ Ð¸Ð· GitHub UI

jobs:
  deploy:
    name: Deploy to Production VPS
    runs-on: ubuntu-latest

    steps:
    - name: ðŸš€ Deploy to VPS via SSH
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: ${{ secrets.VPS_PORT }}
        script: |
          echo "ðŸ“¦ Starting deployment..."

          # ÐŸÐµÑ€ÐµÑ…Ð¾Ð´Ð¸Ð¼ Ð² Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
          cd ~/chess-telegram-miniapp || exit 1

          # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ
          echo "ðŸ”„ Pulling latest changes..."
          git pull origin main

          # ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ .env Ñ„Ð°Ð¹Ð» Ñ ÑÐµÐºÑ€ÐµÑ‚Ð°Ð¼Ð¸ Ð¸Ð· GitHub
          echo "âš™ï¸  Updating environment variables..."
          cat > .env << EOF
          # Supabase Configuration
          SUPABASE_URL=${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_KEY=${{ secrets.SUPABASE_SERVICE_KEY }}

          # Backend Configuration
          BACKEND_URL=${{ secrets.BACKEND_URL }}

          # Stockfish Configuration
          STOCKFISH_THREADS=2
          STOCKFISH_HASH_SIZE=512

          # AI API Configuration
          AI_PROVIDER=deepseek
          AI_API_KEY=${{ secrets.AI_API_KEY }}

          # CORS Configuration
          CORS_ORIGIN=${{ secrets.BACKEND_URL }}

          # Domain Configuration
          DOMAIN=${{ secrets.DOMAIN }}
          EMAIL=${{ secrets.EMAIL }}
          EOF

          # ÐŸÐµÑ€ÐµÑÐ±Ð¾Ñ€ÐºÐ° Ð¸ Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²
          echo "ðŸ‹ Rebuilding and restarting containers..."
          docker compose -f docker-compose.vps.yml up -d --build

          # Ð–Ð´ÐµÐ¼ Ð¿Ð¾ÐºÐ° ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹ Ð·Ð°Ð¿ÑƒÑÑ‚ÑÑ‚ÑÑ
          echo "â³ Waiting for services to start..."
          sleep 10

          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²
          echo "âœ… Checking container status..."
          docker compose -f docker-compose.vps.yml ps

          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð·Ð´Ð¾Ñ€Ð¾Ð²ÑŒÐµ backend
          echo "ðŸ¥ Checking backend health..."
          docker exec chess-backend curl -f http://localhost:3000/health || echo "âš ï¸  Health check failed"

          # ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° ÑÑ‚Ð°Ñ€Ñ‹Ñ… Docker Ð¾Ð±Ñ€Ð°Ð·Ð¾Ð² (ÑÐºÐ¾Ð½Ð¾Ð¼Ð¸Ð¼ Ð¼ÐµÑÑ‚Ð¾)
          echo "ðŸ§¹ Cleaning up old images..."
          docker image prune -af

          echo "âœ¨ Deployment completed!"

    - name: ðŸ“Š Deployment Status
      if: always()
      run: |
        if [ ${{ job.status }} == 'success' ]; then
          echo "âœ… Deployment successful!"
        else
          echo "âŒ Deployment failed!"
        fi
