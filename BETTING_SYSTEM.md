# –°–∏—Å—Ç–µ–º–∞ —Å—Ç–∞–≤–æ–∫ –¥–ª—è –∏–≥—Ä—ã —á–µ–ª–æ–≤–µ–∫ –ø—Ä–æ—Ç–∏–≤ —á–µ–ª–æ–≤–µ–∫–∞

## üìã –û–±–∑–æ—Ä

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Å—Ç–∞–≤–æ–∫ –¥–ª—è –∏–≥—Ä —á–µ–ª–æ–≤–µ–∫ –ø—Ä–æ—Ç–∏–≤ —á–µ–ª–æ–≤–µ–∫–∞ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π:
- üéÆ **–ë–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –∏–≥—Ä** - –±–µ–∑ —Å—Ç–∞–≤–æ–∫
- ‚≠ê **–ò–≥—Ä –Ω–∞ Telegram Stars** - –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è –≤–∞–ª—é—Ç–∞ Telegram
- üí∞ **–ò–≥—Ä –Ω–∞ –º–æ–Ω–µ—Ç—ã** - –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –≤–∞–ª—é—Ç–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã

### –ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏
- ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤ –≤ —ç—Å–∫—Ä–æ—É
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –≤—ã–∏–≥—Ä—ã—à–∞ –ø–æ–±–µ–¥–∏—Ç–µ–ª—é
- ‚úÖ –ö–æ–º–∏—Å—Å–∏—è –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã 10%
- ‚úÖ –í–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤ –ø—Ä–∏ –Ω–∏—á—å–µ–π (–º–∏–Ω—É—Å 5% –∫–æ–º–∏—Å—Å–∏–∏)
- ‚úÖ Real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –¥–µ–ø–æ–∑–∏—Ç–æ–≤
- ‚úÖ –ü–æ–ª–Ω–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è

---

## üìÇ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### 1. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (Supabase)

#### –ú–∏–≥—Ä–∞—Ü–∏–∏:
```
supabase/migrations/
‚îú‚îÄ‚îÄ 20250123000004_betting_system.sql         # –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã
‚îî‚îÄ‚îÄ 20250123000005_betting_rls_policies.sql   # –ü–æ–ª–∏—Ç–∏–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
```

#### –¢–∞–±–ª–∏—Ü—ã:

**`user_wallets`** - –ö–æ—à–µ–ª—å–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- `balance_coins` - –ë–∞–ª–∞–Ω—Å –≤ –º–æ–Ω–µ—Ç–∞—Ö
- `balance_stars` - –ë–∞–ª–∞–Ω—Å –≤ Telegram Stars
- `total_won/lost` - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤—ã–∏–≥—Ä—ã—à–µ–π/–ø—Ä–æ–∏–≥—Ä—ã—à–µ–π

**`game_bets`** - –°—Ç–∞–≤–∫–∏ –Ω–∞ –∏–≥—Ä—ã
- `bet_type` - –¢–∏–ø (free/coins/stars)
- `bet_amount` - –°—É–º–º–∞ —Å—Ç–∞–≤–∫–∏
- `white/black_deposit_status` - –°—Ç–∞—Ç—É—Å—ã –¥–µ–ø–æ–∑–∏—Ç–æ–≤
- `platform_fee_percentage` - –ü—Ä–æ—Ü–µ–Ω—Ç –∫–æ–º–∏—Å—Å–∏–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 10%)
- `winner_payout` - –í—ã–ø–ª–∞—Ç–∞ –ø–æ–±–µ–¥–∏—Ç–µ–ª—é

**`wallet_transactions`** - –ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
- –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –∫–æ—à–µ–ª—å–∫–æ–º –ª–æ–≥–∏—Ä—É—é—Ç—Å—è
- –°–≤—è–∑—å —Å –∏–≥—Ä–∞–º–∏ –∏ —Å—Ç–∞–≤–∫–∞–º–∏

#### –§—É–Ω–∫—Ü–∏–∏ PostgreSQL:

**`deposit_game_bet(game_id, user_id)`**
- –ë–ª–æ–∫–∏—Ä—É–µ—Ç —Å—Ä–µ–¥—Å—Ç–≤–∞ –∏–≥—Ä–æ–∫–∞
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –±–∞–ª–∞–Ω—Å
- –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—á–∏–Ω–∞–µ—Ç –∏–≥—Ä—É –∫–æ–≥–¥–∞ –æ–±–∞ –≤–Ω–µ—Å–ª–∏ –¥–µ–ø–æ–∑–∏—Ç

**`calculate_bet_payout(amount, fee_percentage)`**
- –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –≤—ã–∏–≥—Ä—ã—à —Å —É—á–µ—Ç–æ–º –∫–æ–º–∏—Å—Å–∏–∏

**`process_bet_payout()`** - –¢—Ä–∏–≥–≥–µ—Ä
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –∏–≥—Ä—ã
- –ù–∞—á–∏—Å–ª—è–µ—Ç –≤—ã–∏–≥—Ä—ã—à –ø–æ–±–µ–¥–∏—Ç–µ–ª—é
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–∏—á—å—é —Å –≤–æ–∑–≤—Ä–∞—Ç–æ–º —Å—Ä–µ–¥—Å—Ç–≤

**`refund_game_bet(game_id, reason)`**
- –í–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –∏–≥—Ä—ã

#### –ù–æ–≤—ã–µ —Å—Ç–∞—Ç—É—Å—ã –∏–≥—Ä—ã:
- `pending_bet_setup` - –û–∂–∏–¥–∞–Ω–∏–µ –≤—ã–±–æ—Ä–∞ —Ä–µ–∂–∏–º–∞
- `pending_bet_acceptance` - –û–∂–∏–¥–∞–Ω–∏–µ –ø—Ä–∏–Ω—è—Ç–∏—è —Å—Ç–∞–≤–∫–∏
- `pending_deposits` - –û–∂–∏–¥–∞–Ω–∏–µ –¥–µ–ø–æ–∑–∏—Ç–æ–≤

---

### 2. Frontend

#### TypeScript —Ç–∏–ø—ã
**`frontend/src/types/supabase.ts`**
- –î–æ–±–∞–≤–ª–µ–Ω—ã –≤—Å–µ —Ç–∏–ø—ã –¥–ª—è betting system
- `BetType`, `BetStatus`, `TransactionType`
- `UserWallet`, `GameBet`, `WalletTransaction`
- Realtime payload —Ç–∏–ø—ã

#### React Hooks

**`frontend/src/hooks/useWallet.ts`**
```typescript
const { wallet, transactions, hasBalance, refreshWallet } = useWallet(userId);
```
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ—à–µ–ª—å–∫–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- Real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞
- –ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ—Å—Ç–∏ —Å—Ä–µ–¥—Å—Ç–≤

**`frontend/src/hooks/useGameBet.ts`**
```typescript
const { bet, createBet, acceptBet, depositBet } = useGameBet(gameId, userId);
```
- –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç–∞–≤–∫–∏ (—Ç–æ–ª—å–∫–æ –±–µ–ª—ã–π –∏–≥—Ä–æ–∫)
- –ü—Ä–∏–Ω—è—Ç–∏–µ —Å—Ç–∞–≤–∫–∏ (—á–µ—Ä–Ω—ã–π –∏–≥—Ä–æ–∫)
- –í–Ω–µ—Å–µ–Ω–∏–µ –¥–µ–ø–æ–∑–∏—Ç–∞
- Real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞

**`frontend/src/hooks/useTelegramPayment.ts`**
```typescript
const { packages, createInvoice, sendInvoice, processSuccessfulPayment } = useTelegramPayment(token);
```
- –ü–æ–∫—É–ø–∫–∞ Telegram Stars
- –°–æ–∑–¥–∞–Ω–∏–µ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –∏–Ω–≤–æ–π—Å–æ–≤
- –û–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å–ø–µ—à–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π
- –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø–∞–∫–µ—Ç–æ–≤ —Å –±–æ–Ω—É—Å–∞–º–∏

#### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã UI

**`GameModePopup.tsx`**
- –í—ã–±–æ—Ä —Ä–µ–∂–∏–º–∞ –∏–≥—Ä—ã (–±–µ—Å–ø–ª–∞—Ç–Ω—ã–π/stars/coins)
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –±–µ–ª–æ–º—É –∏–≥—Ä–æ–∫—É –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∏–≥—Ä—ã
- –ö—Ä–∞—Å–∏–≤—ã–π –¥–∏–∑–∞–π–Ω —Å –≥—Ä–∞–¥–∏–µ–Ω—Ç–∞–º–∏

**`BetAmountPopup.tsx`**
- –í–≤–æ–¥ —Å—É–º–º—ã —Å—Ç–∞–≤–∫–∏
- –ü–æ–∫–∞–∑ –±–∞–ª–∞–Ω—Å–∞
- –ë—ã—Å—Ç—Ä—ã–π –≤—ã–±–æ—Ä (preset amounts)
- –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –≤—ã–∏–≥—Ä—ã—à–∞:
  - –û–±—â–∏–π –±–∞–Ω–∫ = —Å—Ç–∞–≤–∫–∞ √ó 2
  - –ö–æ–º–∏—Å—Å–∏—è = –±–∞–Ω–∫ √ó 10%
  - –í—ã–∏–≥—Ä—ã—à = –±–∞–Ω–∫ - –∫–æ–º–∏—Å—Å–∏—è

**`BetConfirmationPopup.tsx`**
- –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É—Å–ª–æ–≤–∏–π –∏–≥—Ä—ã
- –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—Ç–∞–≤–∫–µ
- –ß–µ–∫–±–æ–∫—Å –ø—Ä–∏–Ω—è—Ç–∏—è —É—Å–ª–æ–≤–∏–π
- –†–∞–∑–Ω—ã–µ —Ä–µ–∂–∏–º—ã –¥–ª—è proposer/acceptor

**`DepositWaitingPopup.tsx`**
- –°—Ç–∞—Ç—É—Å –¥–µ–ø–æ–∑–∏—Ç–æ–≤ –æ–±–æ–∏—Ö –∏–≥—Ä–æ–∫–æ–≤
- –ö–Ω–æ–ø–∫–∞ –≤–Ω–µ—Å–µ–Ω–∏—è –¥–µ–ø–æ–∑–∏—Ç–∞
- Real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–≥–¥–∞ –æ–±–∞ –≤–Ω–µ—Å–ª–∏
- –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ –∏–≥—Ä—ã

**`PurchaseStarsPopup.tsx`**
- –ü–æ–∫—É–ø–∫–∞ Telegram Stars –ø–∞–∫–µ—Ç–∞–º–∏
- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –±–∞–ª–∞–Ω—Å–∞
- –ü–∞–∫–µ—Ç—ã —Å –±–æ–Ω—É—Å–∞–º–∏
- –ö–∞—Å—Ç–æ–º–Ω–∞—è —Å—É–º–º–∞ –ø–æ–∫—É–ø–∫–∏
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Telegram Payment API

---

## üéÆ Flow –ø—Ä–æ—Ü–µ—Å—Å–∞ —Å—Ç–∞–≤–æ–∫

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è –∏–≥—Ä–∞
```
1. –ë–µ–ª—ã–π –≤—ã–±–∏—Ä–∞–µ—Ç "–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –±–∞—Ç–ª" –≤ GameModePopup
2. –°–æ–∑–¥–∞–µ—Ç—Å—è game_bet —Å type='free'
3. –ò–≥—Ä–∞ —Å—Ä–∞–∑—É –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è (status = 'active')
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ü–ª–∞—Ç–Ω–∞—è –∏–≥—Ä–∞ (Stars/Coins)

```
1. –ë–µ–ª—ã–π –∏–≥—Ä–æ–∫ —Å–æ–∑–¥–∞–µ—Ç –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ
   ‚Üì
2. –ß–µ—Ä–Ω—ã–π –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ
   ‚Üì game.status = 'pending_bet_setup'

3. GameModePopup –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ë–ï–õ–û–ú–£
   - –í—ã–±–∏—Ä–∞–µ—Ç Stars –∏–ª–∏ Coins
   ‚Üì

4. BetAmountPopup - –ë–ï–õ–´–ô –≤–≤–æ–¥–∏—Ç —Å—É–º–º—É
   - –í–∏–¥–∏—Ç –∫–∞–ª—å–∫—É–ª—è—Ü–∏—é –≤—ã–∏–≥—Ä—ã—à–∞
   - –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç
   ‚Üì game.status = 'pending_bet_acceptance'

5. BetConfirmationPopup –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ß–ï–†–ù–û–ú–£
   - –í–∏–¥–∏—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Å—Ç–∞–≤–∫–∏
   - –ß–∏—Ç–∞–µ—Ç —É—Å–ª–æ–≤–∏—è
   - –ü—Ä–∏–Ω–∏–º–∞–µ—Ç checkbox
   - –ù–∞–∂–∏–º–∞–µ—Ç "–ü—Ä–∏–Ω—è—Ç—å –∏ –≤–Ω–µ—Å—Ç–∏ –¥–µ–ø–æ–∑–∏—Ç"
   ‚Üì game.status = 'pending_deposits'

6. DepositWaitingPopup –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –û–ë–û–ò–ú
   - –ö–∞–∂–¥—ã–π –≤–∏–¥–∏—Ç —Å—Ç–∞—Ç—É—Å —Å–≤–æ–µ–≥–æ –∏ —á—É–∂–æ–≥–æ –¥–µ–ø–æ–∑–∏—Ç–∞
   - –ë–µ–ª—ã–π –Ω–∞–∂–∏–º–∞–µ—Ç "–í–Ω–µ—Å—Ç–∏ –¥–µ–ø–æ–∑–∏—Ç"
     ‚Üí –í—ã–∑—ã–≤–∞–µ—Ç—Å—è deposit_game_bet()
     ‚Üí –°—Ä–µ–¥—Å—Ç–≤–∞ –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è
     ‚Üí white_deposit_status = 'locked'

   - –ß–µ—Ä–Ω—ã–π –Ω–∞–∂–∏–º–∞–µ—Ç "–í–Ω–µ—Å—Ç–∏ –¥–µ–ø–æ–∑–∏—Ç"
     ‚Üí –í—ã–∑—ã–≤–∞–µ—Ç—Å—è deposit_game_bet()
     ‚Üí –°—Ä–µ–¥—Å—Ç–≤–∞ –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è
     ‚Üí black_deposit_status = 'locked'

   - –ö–æ–≥–¥–∞ –û–ë–ê –≤–Ω–µ—Å–ª–∏:
     ‚Üí game_bet.status = 'locked'
     ‚Üí game.status = 'active'
     ‚Üí total_pot = amount * 2
     ‚Üí –ò–ì–†–ê –ù–ê–ß–ò–ù–ê–ï–¢–°–Ø
   ‚Üì

7. –ò–≥—Ä–∞ –∏–¥–µ—Ç...
   ‚Üì

8. –ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è (winner –æ–ø—Ä–µ–¥–µ–ª–µ–Ω)
   ‚Üí –¢—Ä–∏–≥–≥–µ—Ä process_bet_payout() —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

   –ï—Å–ª–∏ –ü–û–ë–ï–î–ê:
     ‚Üí winner_payout = total_pot * 0.9 (–º–∏–Ω—É—Å 10%)
     ‚Üí –°—Ä–µ–¥—Å—Ç–≤–∞ –∑–∞—á–∏—Å–ª—è—é—Ç—Å—è –ø–æ–±–µ–¥–∏—Ç–µ–ª—é
     ‚Üí –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è wallet.total_won
     ‚Üí –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è wallet.total_lost —É –ø—Ä–æ–∏–≥—Ä–∞–≤—à–µ–≥–æ

   –ï—Å–ª–∏ –ù–ò–ß–¨–Ø:
     ‚Üí –ö–∞–∂–¥–æ–º—É –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –µ–≥–æ —Å—Ç–∞–≤–∫–∞ –º–∏–Ω—É—Å 5%
     ‚Üí refund_amount = bet_amount * 0.95
     ‚Üí –ö–æ–º–∏—Å—Å–∏—è 5% + 5% = 10% –æ—Å—Ç–∞–µ—Ç—Å—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ
```

---

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### Row Level Security (RLS)

**user_wallets:**
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤–∏–¥—è—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–π –∫–æ—à–µ–ª–µ–∫
- –¢–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü –º–æ–∂–µ—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å

**game_bets:**
- –¢–æ–ª—å–∫–æ –∏–≥—Ä–æ–∫–∏ –≤–∏–¥—è—Ç —Å—Ç–∞–≤–∫—É —Å–≤–æ–µ–π –∏–≥—Ä—ã
- –¢–æ–ª—å–∫–æ –±–µ–ª—ã–π –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞—Ç—å —Å—Ç–∞–≤–∫—É
- –û–±–∞ –º–æ–≥—É—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å (–¥–ª—è acceptance/deposit)

**wallet_transactions:**
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤–∏–¥—è—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
- –í—Å—Ç–∞–≤–∫–∏ —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–≤–æ–µ–≥–æ user_id

### –ü—Ä–æ–≤–µ—Ä–∫–∏ –≤ —Ñ—É–Ω–∫—Ü–∏—è—Ö

**`deposit_game_bet()`:**
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - —É—á–∞—Å—Ç–Ω–∏–∫ –∏–≥—Ä—ã
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ—Å—Ç–∏ –±–∞–ª–∞–Ω—Å–∞
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –µ—â–µ –Ω–µ –≤–Ω–µ—Å –¥–µ–ø–æ–∑–∏—Ç
- ‚úÖ –ê—Ç–æ–º–∞—Ä–Ω–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è (–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ + –∑–∞–ø–∏—Å—å)

---

## üöÄ –ß—Ç–æ –æ—Å—Ç–∞–ª–æ—Å—å —Å–¥–µ–ª–∞—Ç—å

### Backend (NestJS)

#### 1. WalletModule
```typescript
// backend/src/wallet/wallet.module.ts
// backend/src/wallet/wallet.service.ts
// backend/src/wallet/wallet.controller.ts
```
–ù—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å:
- API endpoints –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞
- API –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
- –ú–µ—Ç–æ–¥—ã –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è —á–µ—Ä–µ–∑ Telegram Stars

#### 2. GameBetsModule
```typescript
// backend/src/game-bets/game-bets.module.ts
// backend/src/game-bets/game-bets.service.ts
// backend/src/game-bets/game-bets.controller.ts
```
–ù—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å:
- API –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è/–ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞–≤–æ–∫
- –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å—Ç–∞–≤–æ–∫
- –í–∞–ª–∏–¥–∞—Ü–∏—è

#### 3. PaymentModule ‚úÖ
```typescript
// backend/src/payment/payment.module.ts
// backend/src/payment/payment.service.ts
// backend/src/payment/payment.controller.ts
```
–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Telegram Stars API
- ‚úÖ `createStarsInvoice()` - —Å–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–≤–æ–π—Å–∞ –¥–ª—è –ø–æ–∫—É–ø–∫–∏ Stars
- ‚úÖ `validatePreCheckout()` - –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–µ—Ä–µ–¥ –æ–ø–ª–∞—Ç–æ–π
- ‚úÖ `processSuccessfulPayment()` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã
- ‚úÖ `getStarsPackages()` - –ø–∞–∫–µ—Ç—ã Stars —Å –±–æ–Ω—É—Å–∞–º–∏
- ‚úÖ REST API endpoints

–ü–∞–∫–µ—Ç—ã Stars —Å –±–æ–Ω—É—Å–∞–º–∏:
- 10 Stars - Starter Pack
- 50 Stars + 5 bonus - Popular Pack
- 100 Stars + 15 bonus - Premium Pack
- 250 Stars + 50 bonus - Elite Pack
- 500 Stars + 125 bonus - Champion Pack
- 1000 Stars + 300 bonus - Master Pack

Frontend:
- ‚úÖ `useTelegramPayment` hook
- ‚úÖ `PurchaseStarsPopup` component
- ‚úÖ –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è (EN/RU)

API:
```typescript
POST /api/payment/create-invoice    // Create invoice
POST /api/payment/pre-checkout       // Validate pre-checkout
POST /api/payment/successful-payment // Process payment
GET  /api/payment/packages           // Get Stars packages
```

### Frontend Integration

#### MainMenu.tsx
–ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:
1. –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –∏–≥—Ä—ã ‚Üí –ø–æ–∫–∞–∑–∞—Ç—å GameModePopup
2. –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ä–µ–∂–∏–º–∞:
   - free ‚Üí —Å—Ä–∞–∑—É —Å—Ç–∞—Ä—Ç
   - stars/coins ‚Üí –ø–æ–∫–∞–∑–∞—Ç—å BetAmountPopup
3. –ü–æ—Å–ª–µ –≤–≤–æ–¥–∞ —Å—É–º–º—ã ‚Üí —Å–æ–∑–¥–∞—Ç—å bet —á–µ—Ä–µ–∑ useGameBet

#### OnlineGamePage.tsx
–ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:
1. –ü–æ–¥–ø–∏—Å–∫—É –Ω–∞ game_bets —á–µ—Ä–µ–∑ useGameBet
2. –ü–æ–∫–∞–∑ BetConfirmationPopup –¥–ª—è —á–µ—Ä–Ω–æ–≥–æ
3. –ü–æ–∫–∞–∑ DepositWaitingPopup –∫–æ–≥–¥–∞ status='pending_deposits'
4. Badge —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Å—Ç–∞–≤–∫–µ –Ω–∞ –¥–æ—Å–∫–µ

### –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è

–î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ–≤–æ–¥—ã –≤ `frontend/src/locales/`:
```json
{
  "betting": {
    "selectGameMode": "Select game mode",
    "freeBattle": "Free battle",
    "starsGame": "Telegram Stars game",
    ...
  }
}
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –°—Ü–µ–Ω–∞—Ä–∏–∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:

1. **–ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è –∏–≥—Ä–∞**
   - ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ
   - ‚úÖ –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π —Å—Ç–∞—Ä—Ç
   - ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –±–µ–∑ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–π

2. **–ò–≥—Ä–∞ –Ω–∞ Stars**
   - ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç–∞–≤–∫–∏
   - ‚úÖ –ü—Ä–∏–Ω—è—Ç–∏–µ —É—Å–ª–æ–≤–∏–π
   - ‚úÖ –í–Ω–µ—Å–µ–Ω–∏–µ –¥–µ–ø–æ–∑–∏—Ç–æ–≤
   - ‚úÖ –°—Ç–∞—Ä—Ç –ø–æ—Å–ª–µ –æ–±–æ–∏—Ö –¥–µ–ø–æ–∑–∏—Ç–æ–≤
   - ‚úÖ –í—ã–ø–ª–∞—Ç–∞ –ø–æ–±–µ–¥–∏—Ç–µ–ª—é
   - ‚úÖ –ö–æ–º–∏—Å—Å–∏—è –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã

3. **–ò–≥—Ä–∞ –Ω–∞ Coins**
   - ‚úÖ –¢–æ –∂–µ —á—Ç–æ Stars –Ω–æ —Å –º–æ–Ω–µ—Ç–∞–º–∏

4. **Edge cases**
   - ‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤
   - ‚ùå –û—Ç–º–µ–Ω–∞ –¥–æ –¥–µ–ø–æ–∑–∏—Ç–∞
   - ‚ùå –û–¥–∏–Ω –≤–Ω–µ—Å, –≤—Ç–æ—Ä–æ–π –æ—Ç–º–µ–Ω–∏–ª (refund)
   - ‚úÖ –ù–∏—á—å—è (–≤–æ–∑–≤—Ä–∞—Ç —Å –∫–æ–º–∏—Å—Å–∏–µ–π 5%)
   - ‚ùå Timeout –¥–µ–ø–æ–∑–∏—Ç–∞ (5 –º–∏–Ω—É—Ç)

---

## üìä Database Schema Diagram

```
users (—Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è)
  ‚Üì (1:1)
user_wallets (–Ω–æ–≤–∞—è)
  ‚îú‚îÄ‚îÄ balance_coins
  ‚îú‚îÄ‚îÄ balance_stars
  ‚îî‚îÄ‚îÄ statistics

games (—Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è, –æ–±–Ω–æ–≤–ª–µ–Ω–∞)
  ‚îú‚îÄ‚îÄ status (–Ω–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è)
  ‚îî‚îÄ‚îÄ ‚Üì (1:1)
     game_bets (–Ω–æ–≤–∞—è)
       ‚îú‚îÄ‚îÄ bet_type
       ‚îú‚îÄ‚îÄ bet_amount
       ‚îú‚îÄ‚îÄ deposit_statuses
       ‚îî‚îÄ‚îÄ payout_info

wallet_transactions (–Ω–æ–≤–∞—è)
  ‚îú‚îÄ‚îÄ user_id ‚Üí users
  ‚îú‚îÄ‚îÄ wallet_id ‚Üí user_wallets
  ‚îú‚îÄ‚îÄ game_id ‚Üí games
  ‚îî‚îÄ‚îÄ game_bet_id ‚Üí game_bets
```

---

## üé® UI/UX Notes

### –¶–≤–µ—Ç–æ–≤–∞—è —Å—Ö–µ–º–∞:
- **Free game**: –ó–µ–ª–µ–Ω—ã–π (emerald-500)
- **Stars game**: –ñ–µ–ª—Ç—ã–π (yellow-500)
- **Coins game**: –°–∏–Ω–∏–π-—Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π (blue-500/purple-500)
- **Success states**: –ó–µ–ª–µ–Ω—ã–π
- **Waiting states**: –°–∏–Ω–∏–π
- **Warning/Terms**: Amber
- **Error/Danger**: –ö—Ä–∞—Å–Ω—ã–π

### –ê–Ω–∏–º–∞—Ü–∏–∏:
- Hover scale: 1.05
- Active scale: 0.95
- Transitions: 300ms
- Backdrop blur –Ω–∞ –º–æ–¥–∞–ª–∫–∞—Ö

---

## üìù API Endpoints (TODO)

```typescript
// Wallet endpoints ‚úÖ
GET    /api/wallet                    // Get user wallet
GET    /api/wallet/transactions       // Get transaction history
GET    /api/wallet/balance/:currency  // Get balance for currency
POST   /api/wallet/coins/add          // Add coins (admin/rewards)
POST   /api/wallet/coins/withdraw     // Withdraw coins
GET    /api/wallet/statistics         // Get wallet statistics

// Game Bets endpoints ‚úÖ
GET    /api/game-bets/:gameId         // Get bet for game
POST   /api/game-bets                 // Create bet
POST   /api/game-bets/:gameId/accept  // Accept bet terms
POST   /api/game-bets/:gameId/deposit // Deposit (calls DB function)
DELETE /api/game-bets/:gameId         // Cancel bet
POST   /api/game-bets/calculate-payout // Calculate potential payout
GET    /api/game-bets/stats/overview  // Get betting statistics

// Telegram Payments ‚úÖ
POST   /api/payment/create-invoice    // Create Stars invoice
POST   /api/payment/pre-checkout      // Validate pre-checkout query
POST   /api/payment/successful-payment // Process successful payment
GET    /api/payment/packages          // Get Stars packages with bonuses
```

---

## üí° –°–æ–≤–µ—Ç—ã –ø–æ –¥–∞–ª—å–Ω–µ–π—à–µ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ

1. **–ù–∞—á–Ω–∏—Ç–µ —Å backend –º–æ–¥—É–ª–µ–π** - –æ–Ω–∏ –Ω—É–∂–Ω—ã –¥–ª—è –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–π —Ä–∞–±–æ—Ç—ã

2. **Telegram Stars –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è** —Ç—Ä–µ–±—É–µ—Ç:
   - Bot Token —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –ø–ª–∞—Ç–µ–∂–µ–π
   - –ù–∞—Å—Ç—Ä–æ–π–∫—É webhook
   - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ Telegram

3. **–õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è** - –¥–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–µ–≤–æ–¥—ã –¥–ª—è –≤—Å–µ—Ö —Ç–µ–∫—Å—Ç–æ–≤

4. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** - –ª–æ–≥–∏—Ä—É–π—Ç–µ –≤—Å–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

5. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** - –≤—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ –±–∞–ª–∞–Ω—Å –ø–µ—Ä–µ–¥ –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏

6. **UX** - –¥–æ–±–∞–≤—å—Ç–µ loading states –∏ error handling

---

## üéØ –ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

### Database ‚úÖ
- –ú–∏–≥—Ä–∞—Ü–∏–∏ —Å–æ–∑–¥–∞–Ω—ã
- –§—É–Ω–∫—Ü–∏–∏ –∏ —Ç—Ä–∏–≥–≥–µ—Ä—ã —Ä–∞–±–æ—Ç–∞—é—Ç
- RLS policies –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã

### Frontend ‚úÖ
- TypeScript —Ç–∏–ø—ã
- React hooks (useWallet, useGameBet)
- UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (4 popup'–∞)

### Backend ‚úÖ
- WalletModule –∏ GameBetsModule —Å–æ–∑–¥–∞–Ω—ã
- PaymentModule –¥–ª—è Telegram Stars –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
- REST API endpoints

### Integration ‚úÖ
- MainMenu –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω —Å betting flow
- OnlineGamePage –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ popup'—ã
- –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è (EN/RU) –¥–æ–±–∞–≤–ª–µ–Ω–∞

---

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ ~~–°–æ–∑–¥–∞—Ç—å backend –º–æ–¥—É–ª–∏ (Wallet, GameBets, Payment)~~
2. ‚úÖ ~~–ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –≤ MainMenu –∏ OnlineGamePage~~
3. ‚úÖ ~~–î–æ–±–∞–≤–∏—Ç—å –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—é~~
4. ‚è≥ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏
5. ‚è≥ –î–µ–ø–ª–æ–π –º–∏–≥—Ä–∞—Ü–∏–π –Ω–∞ production Supabase
6. ‚è≥ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Telegram bot –¥–ª—è –ø–ª–∞—Ç–µ–∂–µ–π (–¥–ª—è —Ä–∞–±–æ—Ç—ã Stars –Ω—É–∂–µ–Ω Bot Token)
7. ‚è≥ E2E —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ betting flow

## üì¶ –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –≥–æ—Ç–æ–≤—ã –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

### Backend Modules:
- ‚úÖ `WalletModule` - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ—à–µ–ª—å–∫–∞–º–∏
- ‚úÖ `GameBetsModule` - —Å–∏—Å—Ç–µ–º–∞ —Å—Ç–∞–≤–æ–∫
- ‚úÖ `PaymentModule` - Telegram Stars –ø–æ–∫—É–ø–∫–∏

### Frontend Components:
- ‚úÖ `GameModePopup` - –≤—ã–±–æ—Ä —Ä–µ–∂–∏–º–∞ –∏–≥—Ä—ã
- ‚úÖ `BetAmountPopup` - –≤–≤–æ–¥ —Å—É–º–º—ã —Å—Ç–∞–≤–∫–∏
- ‚úÖ `BetConfirmationPopup` - –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É—Å–ª–æ–≤–∏–π
- ‚úÖ `DepositWaitingPopup` - –æ–∂–∏–¥–∞–Ω–∏–µ –¥–µ–ø–æ–∑–∏—Ç–æ–≤
- ‚úÖ `PurchaseStarsPopup` - –ø–æ–∫—É–ø–∫–∞ Telegram Stars

### Hooks:
- ‚úÖ `useWallet` - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ—à–µ–ª—å–∫–æ–º
- ‚úÖ `useGameBet` - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞–≤–∫–∞–º–∏
- ‚úÖ `useTelegramPayment` - –ø–æ–∫—É–ø–∫–∞ Stars

### Localization:
- ‚úÖ English (EN)
- ‚úÖ Russian (RU)

## üéâ –°–∏—Å—Ç–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤–∞!

–í—Å–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã. –î–ª—è –∑–∞–ø—É—Å–∫–∞ –≤ production –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ:
1. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –∫ production –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
2. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Telegram Bot —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –ø–ª–∞—Ç–µ–∂–µ–π
3. –ü—Ä–æ–≤–µ—Å—Ç–∏ –ø–æ–ª–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤

---

–°–æ–∑–¥–∞–Ω–æ: 2025-01-26
–ê–≤—Ç–æ—Ä: Claude Code (Sonnet 4.5)
